<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OksfordOS</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#27293C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    
    <style>
        :root {
            --bg-primary: #1a1b26;
            --bg-secondary: #24283b;
            --text-primary: #c0caf5;
            --text-secondary: #9a9a9a;
            --accent: #7aa2f7;
            --danger: #f7768e;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary); 
            color: var(--text-primary); 
            height: 100vh; 
            overflow: hidden;
        }
        
        .app-container { display: flex; height: 100vh; }
        
        .timer-panel {
            width: 180px; min-width: 180px; background: var(--bg-secondary);
            padding: 20px; display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .main-timer { font-size: 3em; font-weight: bold; text-align: center; margin: 20px 0; }
        .ad-timer { font-size: 2em; font-weight: bold; text-align: center; color: #9a9a9a; margin: 10px 0; }
        .question-timer { font-size: 1.5em; text-align: center; margin: 10px 0; }
        
        .shortcuts { 
            font-size: 0.8em; color: var(--text-secondary); line-height: 1.4;
            white-space: pre-line; text-align: left;
        }
        
        .main-content { flex: 1; overflow: hidden; position: relative; }
        .scroll-container { height: 100%; overflow-y: auto; padding: 20px; }
        
        .speaker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .speaker-section { 
            background: var(--bg-secondary); border-radius: 8px; padding: 15px; 
            border: 1px solid #3b4261;
        }
        .speaker-header { 
            text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 15px;
            color: var(--accent);
        }
        
        .info-text, .question-text, .ad-vocem-text, .notatnik { 
            width: 100%; min-height: 40px; max-height: 200px; 
            background: rgba(255,255,255,0.05); border: 1px solid #3b4261;
            border-radius: 4px; padding: 10px; font-size: 1.1em;
            resize: vertical; color: var(--text-primary);
            font-family: inherit;
        }
        .info-text:focus, .question-text:focus, .ad-vocem-text:focus, .notatnik:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(122,162,247,0.2);
        }
        
        .questions-group { margin-top: 15px; }
        .questions-group .question-text { margin-bottom: 10px; display: none; }
        .questions-group .question-text.active { display: block; }
        
        .ad-vocem-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .ad-vocem-section { background: var(--bg-secondary); padding: 15px; border-radius: 8px; border: 1px solid #3b4261; }
        .ad-vocem-title { font-weight: bold; margin-bottom: 10px; }
        
        .notatnik-section { margin: 20px 0; }
        .notatnik-label { font-weight: bold; margin-bottom: 10px; }
        
        .scores-section { 
            background: var(--bg-secondary); padding: 20px; border-radius: 8px; 
            border: 1px solid #3b4261; margin-top: 20px;
        }
        .scores-title { font-weight: bold; margin-bottom: 15px; }
        .scores-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .score-input { 
            height: 50px; font-size: 1.5em; text-align: center;
            background: rgba(255,255,255,0.1); border: 1px solid #3b4261;
            border-radius: 4px; color: var(--text-primary);
        }
        .score-input:focus { border-color: var(--accent); }
        
        .settings-btn { 
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: var(--accent); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-weight: bold;
        }
        
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; 
        }
        .modal-content { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-secondary); padding: 30px; border-radius: 12px;
            width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto;
        }
        .modal h3 { margin-bottom: 20px; }
        .modal-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .modal input { flex: 1; padding: 8px; border: 1px solid #3b4261; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-primary); }
        
        @media (max-width: 768px) {
            .timer-panel { width: 150px; }
            .speaker-grid { grid-template-columns: 1fr; }
            .ad-vocem-row { grid-template-columns: 1fr; }
            .scores-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="timer-panel">
            <div>
                <div class="main-timer" id="mainTimer">04:00</div>
                <div class="ad-timer" id="adTimer">00:30</div>
                <div class="question-timer" id="questionTimer"></div>
            </div>
            <div class="shortcuts">
Ctrl+L/H – Sekcja
Alt+L/H – Mówca  
Ctrl+⏎ – Nowa sekcja
Ctrl+␣ – Timer
Alt+␣ – Ad vocem
Ctrl+1-8 – Mówca
Ctrl+N - Notatnik
Ctrl+R - Reset
Alt+R - Reset mini
Alt+O/P - Scroll
Ctrl+. - Ustawienia
Ctrl+S/O - JSON
            </div>
        </div>
        
        <div class="main-content">
            <div class="scroll-container">
                <div class="speaker-grid" id="speakerGrid"></div>
                
                <div class="ad-vocem-row">
                    <div class="ad-vocem-section">
                        <div class="ad-vocem-title">Ad Vocem Propozycja</div>
                        <textarea class="ad-vocem-text" id="adVocemProp"></textarea>
                    </div>
                    <div class="ad-vocem-section">
                        <div class="ad-vocem-title">Ad Vocem Opozycja</div>
                        <textarea class="ad-vocem-text" id="adVocemOpp"></textarea>
                    </div>
                </div>
                
                <div class="notatnik-section">
                    <div class="notatnik-label">Notatnik</div>
                    <textarea class="notatnik" id="notatnik"></textarea>
                </div>
                
                <div class="scores-section">
                    <div class="scores-title">Punktacja</div>
                    <div class="scores-grid">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                        <input type="number" class="score-input" min="0" max="10" value="0">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="settings-btn" id="settingsBtn">⚙️</button>
    
    <!-- Modal ustawień -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Ustawienia</h3>
            
            <div class="modal-row">
                <label>Główny timer</label>
            </div>
            <div class="modal-row">
                <label>Min:</label>
                <input type="number" id="mainMin" min="0" max="99" value="4">
                <label>Sek:</label>
                <input type="number" id="mainSec" min="0" max="59" value="0">
            </div>
            
            <div class="modal-row">
                <label>Mini timer (s):</label>
                <input type="number" id="adSec" min="1" max="300" value="30">
            </div>
            
            <button style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:6px; color:white; font-weight:bold; margin-top:20px;" id="saveSettings">Zapisz</button>
        </div>
    </div>

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
        
        // Stan aplikacji
        const appState = {
            mainTimer: { seconds: 240, running: false, interval: null },
            adTimer: { seconds: 30, running: false, interval: null },
            currentSpeaker: 0,
            currentSection: 0, // 0=info, 1=q1, 2=q2
            speakers: Array(8).fill().map((_, i) => ({
                side: i < 4 ? 'Propozycja' : 'Opozycja',
                num: (i % 4) + 1,
                info: '',
                question1: '',
                question2: ''
            }))
        };
        
        // DOM elements
        const els = {
            mainTimer: document.getElementById('mainTimer'),
            adTimer: document.getElementById('adTimer'),
            questionTimer: document.getElementById('questionTimer'),
            speakerGrid: document.getElementById('speakerGrid'),
            adVocemProp: document.getElementById('adVocemProp'),
            adVocemOpp: document.getElementById('adVocemOpp'),
            notatnik: document.getElementById('notatnik'),
            scoreInputs: document.querySelectorAll('.score-input'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            saveSettings: document.getElementById('saveSettings')
        };
        
        // Inicjalizacja
        function init() {
            createSpeakers();
            loadSettings();
            setupEventListeners();
            updateTimers();
            document.addEventListener('keydown', handleKeydown);
        }
        
        function createSpeakers() {
            els.speakerGrid.innerHTML = '';
            appState.speakers.forEach((speaker, i) => {
                const div = document.createElement('div');
                div.className = 'speaker-section';
                div.innerHTML = `
                    <div class="speaker-header">Mówca ${speaker.num} (${speaker.side})</div>
                    <textarea class="info-text" placeholder="Informacje mówcy ${speaker.num} ${speaker.side}">${speaker.info}</textarea>
                    <div class="questions-group">
                        <textarea class="question-text" placeholder="Pytanie 1">${speaker.question1}</textarea>
                        <textarea class="question-text" placeholder="Pytanie 2">${speaker.question2}</textarea>
                    </div>
                `;
                div.querySelector('.info-text').addEventListener('input', (e) => {
                    appState.speakers[i].info = e.target.value;
                    toggleQuestions(i);
                });
                div.querySelectorAll('.question-text').forEach((q, qi) => {
                    q.addEventListener('input', (e) => {
                        appState.speakers[i][`question${qi + 1}`] = e.target.value;
                    });
                });
                els.speakerGrid.appendChild(div);
            });
            toggleQuestions(appState.currentSpeaker);
        }
        
        function toggleQuestions(speakerIdx) {
            const questions = els.speakerGrid.children[speakerIdx]?.querySelectorAll('.question-text');
            if (questions) {
                questions[0].classList.toggle('active', appState.speakers[speakerIdx].info.trim());
                questions[1].classList.toggle('active', appState.speakers[speakerIdx].question1.trim());
            }
        }
        
        // Timery
        function updateTimers() {
            const m = Math.floor(appState.mainTimer.seconds / 60);
            const s = appState.mainTimer.seconds % 60;
            els.mainTimer.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            const am = Math.floor(appState.adTimer.seconds / 60);
            const as_ = appState.adTimer.seconds % 60;
            els.adTimer.textContent = `${am.toString().padStart(2, '0')}:${as_.toString().padStart(2, '0')}`;
        }
        
        function startMainTimer() {
            if (!appState.mainTimer.running) {
                appState.mainTimer.interval = setInterval(() => {
                    if (appState.mainTimer.seconds > 0) {
                        appState.mainTimer.seconds--;
                        updateTimers();
                    } else {
                        clearInterval(appState.mainTimer.interval);
                        appState.mainTimer.running = false;
                    }
                }, 1000);
                appState.mainTimer.running = true;
            }
        }
        
        function pauseMainTimer() {
            clearInterval(appState.mainTimer.interval);
            appState.mainTimer.running = false;
        }
        
        function toggleMainTimer() {
            if (appState.mainTimer.running) pauseMainTimer();
            else startMainTimer();
        }
        
        function resetMainTimer() {
            pauseMainTimer();
            appState.mainTimer.seconds = parseInt(localStorage.getItem('mainTimer') || '240');
            updateTimers();
        }
        
        // Analogicznie dla adTimer...
        function startAdTimer() {
            if (!appState.adTimer.running) {
                appState.adTimer.interval = setInterval(() => {
                    if (appState.adTimer.seconds > 0) {
                        appState.adTimer.seconds--;
                        updateTimers();
                    } else {
                        clearInterval(appState.adTimer.interval);
                        appState.adTimer.running = false;
                    }
                }, 1000);
                appState.adTimer.running = true;
            }
        }
        
        function pauseAdTimer() {
            clearInterval(appState.adTimer.interval);
            appState.adTimer.running = false;
        }
        
        function toggleAdTimer() {
            if (appState.adTimer.running) pauseAdTimer();
            else startAdTimer();
        }
        
        function resetAdTimer() {
            pauseAdTimer();
            appState.adTimer.seconds = parseInt(localStorage.getItem('adTimer') || '30');
            updateTimers();
        }
        
        // Nawigacja
        function nextSection() {
            appState.currentSection = (appState.currentSection + 1) % 3;
            focusCurrentSection();
        }
        
        function previousSection() {
            appState.currentSection = (appState.currentSection - 1 + 3) % 3;
            focusCurrentSection();
        }
        
        function nextSpeaker() {
            appState.currentSpeaker = (appState.currentSpeaker + 1) % 8;
            appState.currentSection = 0;
            focusCurrentSection();
        }
        
        function previousSpeaker() {
            appState.currentSpeaker = (appState.currentSpeaker - 1 + 8) % 8;
            appState.currentSection = 0;
            focusCurrentSection();
        }
        
        function focusCurrentSection() {
            const speakerDiv = els.speakerGrid.children[appState.currentSpeaker];
            if (!speakerDiv) return;
            
            const texts = speakerDiv.querySelectorAll('textarea');
            let targetIdx = appState.currentSection;
            
            if (targetIdx === 1 && !texts[1].classList.contains('active')) targetIdx = 0;
            if (targetIdx === 2 && !texts[2].classList.contains('active')) targetIdx = 1;
            
            texts[targetIdx].focus();
            texts[targetIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function jumpToSpeaker(idx) {
            appState.currentSpeaker = idx;
            appState.currentSection = 0;
            focusCurrentSection();
        }
        
        function insertSectionSeparator() {
            const activeEl = document.activeElement;
            if (activeEl && activeEl.tagName === 'TEXTAREA') {
                const start = activeEl.selectionStart;
                const end = activeEl.selectionEnd;
                activeEl.value = activeEl.value.substring(0, start) + '\n------------------\n' + activeEl.value.substring(end);
                activeEl.setSelectionRange(start + 18, start + 18);
            }
        }
        
        // Skróty klawiszowe
        function handleKeydown(e) {
            const combos = {
                'Control+l': nextSection,
                'Control+h': previousSection,
                'Alt+l': nextSpeaker,
                'Alt+h': previousSpeaker,
                'Control+Enter': insertSectionSeparator,
                'Control+space': toggleMainTimer,
                'Alt+space': toggleAdTimer,
                'Control+n': () => els.notatnik.focus(),
                'Control+r': resetMainTimer,
                'Alt+r': resetAdTimer,
                'Control+.': () => els.settingsModal.style.display = 'block',
            };
            
            const keyCombo = `${e.ctrlKey ? 'Control+' : ''}${e.altKey ? 'Alt+' : ''}${e.code === 'Space' ? 'space' : e.key}`;
            if (combos[keyCombo]) combos[keyCombo]();
            
            if (e.ctrlKey && e.key >= '1' && e.key <= '8') {
                jumpToSpeaker(parseInt(e.key) - 1);
            }
        }
        
        // Ustawienia
        function loadSettings() {
            const mainMin = localStorage.getItem('mainMin') || '4';
            const mainSec = localStorage.getItem('mainSec') || '0';
            const adSec = localStorage.getItem('adSec') || '30';
            
            appState.mainTimer.seconds = parseInt(mainMin) * 60 + parseInt(mainSec);
            appState.adTimer.seconds = parseInt(adSec);
            updateTimers();
        }
        
        els.saveSettings.onclick = () => {
            const mainMin = document.getElementById('mainMin').value;
            const mainSec = document.getElementById('mainSec').value;
            const adSec = document.getElementById('adSec').value;
            
            localStorage.setItem('mainMin', mainMin);
            localStorage.setItem('mainSec', mainSec);
            localStorage.setItem('adSec', adSec);
            
            appState.mainTimer.seconds = parseInt(mainMin) * 60 + parseInt(mainSec);
            appState.adTimer.seconds = parseInt(adSec);
            updateTimers();
            
            els.settingsModal.style.display = 'none';
        };
        
        els.settingsBtn.onclick = () => {
            document.getElementById('mainMin').value = Math.floor(appState.mainTimer.seconds / 60);
            document.getElementById('mainSec').value = appState.mainTimer.seconds % 60;
            document.getElementById('adSec').value = appState.adTimer.seconds;
            els.settingsModal.style.display = 'block';
        };
        
        // Zamknij modal kliknięciem poza
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) {
                els.settingsModal.style.display = 'none';
            }
        };
        
        // JSON import/export
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportJSON();
            }
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                importJSON();
            }
        });
        
        function getAppState() {
            const scores = Array.from(els.scoreInputs).map(input => input.value);
            return {
                speakers: appState.speakers,
                adVocem: [els.adVocemProp.value, els.adVocemOpp.value],
                notatnik: els.notatnik.value,
                scores
            };
        }
        
        function exportJSON() {
            const data = getAppState();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'oksfordos.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            appState.speakers = data.speakers || appState.speakers;
                            createSpeakers();
                            els.adVocemProp.value = data.adVocem?.[0] || '';
                            els.adVocemOpp.value = data.adVocem?.[1] || '';
                            els.notatnik.value = data.notatnik || '';
                            data.scores?.forEach((score, i) => {
                                if (els.scoreInputs[i]) els.scoreInputs[i].value = score;
                            });
                        } catch (err) {
                            alert('Błąd wczytywania JSON');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function setupEventListeners() {
            els.adVocemProp.oninput = () => localStorage.setItem('adVocemProp', els.adVocemProp.value);
            els.adVocemOpp.oninput = () => localStorage.setItem('adVocemOpp', els.adVocemOpp.value);
            els.notatnik.oninput = () => localStorage.setItem('notatnik', els.notatnik.value);
            
            // Auto-save scores
            els.scoreInputs.forEach((input, i) => {
                input.onchange = () => localStorage.setItem(`score${i}`, input.value);
            });
        }
        
        // Load saved data
        window.addEventListener('load', () => {
            els.adVocemProp.value = localStorage.getItem('adVocemProp') || '';
            els.adVocemOpp.value = localStorage.getItem('adVocemOpp') || '';
            els.notatnik.value = localStorage.getItem('notatnik') || '';
            els.scoreInputs.forEach((input, i) => {
                input.value = localStorage.getItem(`score${i}`) || '0';
            });
        });
        
        init();
    </script>
</body>
</html>

